{% extends "advertiser/base.html" %}
{% load i18n static %}
{% block title %}{{ request.user }} - Dashboard{% endblock %}
{% block dashboard_content %}
  <div class="dashboard-container">
    <!-- Tab Navigation -->
    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      <div id="overview" class="tab-pane active">
        
        <!-- Top Metrics -->
        <section class="dashboard-section metrics">
          <div class="dashboard-cards">
            <div class="card metric-card">
              <div class="card-content">
                <div class="metric-value" data-metric="ads">{{ summary.total_active_ads|default:"0" }}</div>
                <div class="metric-label">Active Campaigns</div>
              </div>
            </div>
            <div class="card metric-card">
              <div class="card-content">
                <div class="metric-value" data-metric="spend">{{ summary.total_cost|default:"0" }}</div>
                <div class="metric-label">Total Spend</div>
              </div>
            </div>
            <div class="card metric-card">
              <div class="card-content">
                <div class="metric-value" data-metric="impressions">{{ summary.total_impressions|default:"0" }}</div>
                <div class="metric-label">Impressions</div>
              </div>
            </div>
            <div class="card metric-card">
              <div class="card-content">
                <div class="metric-value" data-metric="clicks">{{ summary.total_clicks|default:"0" }}</div>
                <div class="metric-label">Clicks</div>
              </div>
            </div>
            <div class="card metric-card">
              <div class="card-content">
                <div class="metric-value" data-metric="ctr">{{ summary.ctr|default:"0" }}%</div>
                <div class="metric-label">CTR</div>
              </div>
            </div>
          </div>
        </section>
        {% if summary.total_active_ads %}
          <!-- Charts -->
          <section class="dashboard-section charts">
            <div class="grid">
              <div class="chart-card">
                <h3>Impressions</h3>
                <div class="card">
                  <canvas id="impressionsChart" aria-label="Impressions over time"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <h3>Spend</h3>
                <div class="card">
                  <canvas id="spentformanceChart" aria-label="Spend over time"></canvas>
                </div>
              </div>
            </div>
          </section>
          <!-- Performance by Language and Category -->
          <section class="dashboard-section">
            <div class="grid">
              <div class="card language-breakdown-section">
                <div class="section-header">
                  <h2>Language Breakdown</h2>
                </div>
                <div class="section-content grid">
                    <canvas id="languageChart" height="100" width="100"></canvas>
                    
                  <div class="chart-legend" id="languageLegend">
                    {% for lang in languages %}
                      <div class="legend-item">
                        <span class="legend-color" style="background-color: {{ lang.color }};"></span>
                        <span class="legend-label">{{ lang.language }}</span>
                        <span class="legend-value">{{ lang.percentage }}%</span>
                      </div>
                    {% empty %}
                      <p>No language data available</p>
                    {% endfor %}
                  </div>
                </div>
              </div>
              <div>
                <div class="card category-performance-section">
                  <div class="section-header">
                    <h2>Categorical Performance</h2>
                  </div>
                  <div class="table-responsive">
                    <table class="data-table performances-table">
                      <thead>
                        <tr>
                          <th>Interests</th>
                          <th>Impressions</th>
                          <th>CTR</th>
                          <th>Engagement</th>
                        </tr>
                      </thead>
                      <tbody id="categories-table-body">
                        {% for cat in categories %}
                          <tr>
                            <td class="performance-name">{{ cat.category|default:"Unknown" }}</td>
                            <td>{{ cat.performance.total_impressions|default:0 }}</td>
                            <td>{{ cat.performance.total_ctr|floatformat:2|default:0 }}%</td>
                            <td>{{ cat.performance.engagement_rate|floatformat:2|default:0 }}%</td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="4">No category data available</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>
        {% else %}
          <section class="dashboard-section">
            <div class="container grid-2-1 p-0">
              <div class="">
                <img src="{% static "image/cta-add-channel.jpg" %}">
              </div>
              <div class="card">
                <img src="{% static "image/logo-2.png" %}">
                <em class="text-muted p-2" style="border-left: 3px solid crimson; margin: 1rem;">
                  "Accelerating your ads to perfect audiences at Sonic speed. 
                  The fastest Telegram ad delivery platform in time."
                </em>
                <button class="nav-tab btn btn-primary" data-tab="campaigns">+ Launch Campaign Now</button>
              </div>
            </div>
          </section>
        {% endif %}
        <!-- Campaigns (Limited to Top 6) -->
        <section class="dashboard-section campaigns">
          <div class="section-header">
            <h2>Top Campaigns</h2>
            <div class="" >
                <a href="#campaigns" class="nav-tab btn btn-outline btn-sm" data-tab="campaigns">View All</a>
            </div>
          </div>
          <div class="table-responsive">
            <table class="data-table campaigns-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Start</th>
                  <th>Budget(ETB)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
      <!-- Campaigns Tab -->
      <div id="campaigns" class="tab-pane">
        <div class="modal active" aria-hidden="false" role="dialog">
          <div class="modal-content" style="max-width: 1200px; box-shadow: 0 18px 30px rgba(0, 0, 0, 0.5);">
            <div class="section-header">
              <h2>All Campaigns</h2>
              <button class="close-modal" onclick="window.__dashboard.switchTab('overview')" aria-label="Close">&times;</button>
            </div>
            <div class="grid-plus">
              <div class="filters">
                <select id="campaigns-period-select" aria-label="Period">
                  <option value="last7" selected>Last 7 days</option>
                  <option value="last30">Last 30 days</option>
                  <option value="month">This month</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>
            <div class="table-responsive mt-2">
              <table class="data-table campaigns-table full">
                <thead>
                </thead>
                <tbody></tbody>
              </table>
              <div class="pagination-controls">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Billing Tab -->
      <div id="billing" class="tab-pane">
        <div class="modal active" aria-hidden="false" role="dialog">
          <div class="modal-content" style="max-width: 1000px;">
            <div class="section-header">
              <h2>Billing</h2>
              <button class="close-modal" onclick="window.__dashboard.switchTab('overview')" aria-label="Close">&times;</button>
            </div>
            <section class="dashboard-section grid-plus">
              <div class="balance">
                <h3>Balance</h3>
                <div class="card">
                  <div class="card-content">
                    <div class="metric-value" id="current-balance">ETB 0</div>
                    <div class="metric-label">Available Balance</div>
                    <div class="btn btn-sm btn-outline--green mt-2 w-full" onclick="window.__dashboard.openTopupModal(0)">
                      Top Up
                    </div>
                  </div>
                </div>
              </div>
              <div class="in-escrow">
                <h3>In Escrow</h3>
                <div class="card">
                  <div class="card-content">
                    <div class="metric-value" id="in-escrow">ETB 0</div>
                    <div class="metric-label">Locked for Campaigns</div>
                  </div>
                </div>
              </div>
              <div class="total-spend">
                <h3>Total Spend</h3>
                <div class="card">
                  <div class="card-content">
                    <div class="metric-value" id="total-spend">ETB 0</div>
                    <div class="metric-label">Total Spend</div>
                  </div>
                </div>
              </div>
                
            </section>
            <section class="dashboard-section transactions">
              <h3>Transactions</h3>
              <div class="table-responsive">
                <table class="data-table transactions-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Type</th>
                      <th>Amount (ETB)</th>
                      <th>Reference</th>
                      <th>Remark</th>
                    </tr>
                  </thead>
                  <tbody id="transactions-body"></tbody>
                </table>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Campaign Create/Edit Modal -->
  <div id="campaignModal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content" role="document" style="max-width:800px;">
      <button class="modal-close close-modal" aria-label="Close">&times;</button>
      <header class="modal-header mt-2">
        <h2 id="campaignModalTitle">Create Campaign</h2>
        <div class="step-indicator" aria-hidden="true">
          <span id="stepLabel">Step 1 of 2</span>
        </div>
      </header>
      <main class="modal-body">
        <form id="campaign-form" data-campaign-id="">
          <!-- STEP 1: Campaign basics & targeting -->
          <section id="campaignStep1" class="campaign-step">
            <div class="grid">
              <div>
                <label for="campaignName">Campaign Name</label>
                <input id="campaignName" name="name" type="text" maxlength="255" required>
                <div class="error-message" id="campaignName-error"></div>
              </div>
              <div>
                <label for="campaignObjective">Objective</label>
                <select id="campaignObjective" name="objective">
                  <option value="brand_awareness">Brand Awareness</option>
                  <option value="engagement">Engagement</option>
                  <option value="conversion">Conversion</option>
                  <option value="traffic">Traffic</option>
                </select>
                <div class="error-message" id="campaignObjective-error"></div>
              </div>
            </div>
            <div class="grid">
              <div>
                <label for="campaignBudget">Initial Budget (ETB)</label>
                <input id="campaignBudget" name="initial_budget" type="number" min="1" step="0.01" required>
                <div class="error-message" id="campaignBudget-error"></div>
              </div>
              <div>
                <label for="campaignCpm">CPM (ETB)</label>
                <input id="campaignCpm" name="cpm" type="number" min="1" step="0.01" required>
                <small class="text-muted">Enter the cost per 1,000 impressions/view</small>
                <div class="error-message" id="campaignCpm-error"></div>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label for="campaignStartDate">Start Date</label>
                <input id="campaignStartDate" name="start_date" type="date">
                <div class="error-message" id="campaignStartDate-error"></div>
              </div>
              <div>
                <label for="campaignEndDate">End Date</label>
                <input id="campaignEndDate" name="end_date" type="date">
                <div class="error-message" id="campaignEndDate-error"></div>
              </div>
              <div>
                <label for="campaignFrequencyCap">Views Frequency Cap (per user)</label>
                <input id="campaignFrequencyCap" name="views_frequency_cap" type="number" min="1" value="1">
                <div class="error-message" id="campaignFrequencyCap-error"></div>
              </div>
            </div>
            <div class="form-row">
              <div class="mt-4 max-w-full">
                <label>Targeting Categories</label>
                <div id="cs_categories" class="checkbox-pill-container"></div>
                <small class="text-muted">Choose one or more categories</small>
                <div class="error-message" id="cs_categories-error"></div>
              </div>
            </div>
            <div class="form-row">
              <div class="mt-4 max-w-full">
                <label>Targeting Languages</label>
                <div id="cs_languages" class="checkbox-pill-container"></div>
                <small class="text-muted">Choose one or more languages</small>
                <div class="error-message" id="cs_languages-error"></div>
              </div>
            </div>
          </section>
          <!-- STEP 2: Ad content -->
          <section id="campaignStep2" class="campaign-step hidden">
            <div id="ad-cards-list" class="ad-cards-list"></div>
            <h4>Add Creative</h4>
            <div class="form-row">
              <div>
                <label for="adHeadline">Headline (≤ 25 chars)</label>
                <input id="adHeadline" maxlength="25" type="text">
                <div class="error-message" id="adHeadline-error"></div>
              </div>
              <div>
                <label for="adText">Text Content (≤ 200 chars)</label>
                <textarea id="adText" maxlength="200" rows="3"></textarea>
                <div class="error-message" id="adText-error"></div>
              </div>
              <div class="mt-4">
                <label for="adImageUrl">Image / Video URL</label>
                <div class="url-input-wrapper">
                  <input id="adImageUrl" type="url" placeholder="https://...     or upload →" class="url-input">
                  <label for="adFile" class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                  </label>
                  <input id="adFile" type="file" accept="image/*,video/*" class="file-input">
                </div>
                <div class="error-message" id="adImageUrl-error"></div>
                <div class="error-message" id="adFile-error"></div>
              </div>
              <div class="mt-4">
                <label for="adBrandName">Brand Name (optional)</label>
                <input id="adBrandName" maxlength="50" type="text">
                <div class="error-message" id="adBrandName-error"></div>
              </div>
              <!-- Social Links -->
              <div class="mt-4">
                <label>Social Media Links (up to 3)</label>
                <div id="social-links-container">
                  <div class="social-link-row mb-2" style="justify-content: flex-end;">
                    <button type="button" id="addSocialLinkBtn" class="btn btn-outline btn-sm"><i class="fas fa-plus"></i> Add Social Link</button>
                  </div>
                </div>
                <div class="error-message" id="social-links-error"></div>
              </div>
              <button type="button" id="addAdBtn" class="btn btn-outline btn-sm mt-2"><i class="fas fa-save"></i> Save</button>
            </div>
          </section>
          <!-- Wizard controls -->
          <footer class="modal-footer" style="margin-top:1rem;">
            <div style="margin-right:auto">
              <button type="button" id="campaignBackBtn" class="card text-success border-0 cursor-pointer" style="display:none;"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div style="display:flex;gap:.5rem;">
              <button type="button" id="campaignNextBtn" class="card text-success border-0 cursor-pointer">Next <i class="fas fa-arrow-right"></i></button>
              <button type="submit" id="campaignSubmitBtn" class="btn btn-primary" style="display:none;">Create Campaign</button>
            </div>
          </footer>
        </form>
      </main>
    </div>
  </div>
  <!-- Performance Modal (per-campaign) -->
  <div id="performanceModal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content" role="document">
      <button class="modal-close close-modal" aria-label="Close">&times;</button>
      <h2>Campaign Performance</h2>
      <div class="grid-2-1">
        <div>
          <div id="perf-summary" class="perf-summary grid-plus gap-3">
            <div class="metrics-card">Spent: <strong id="perf-spend">-</strong> ETB</div>
            <div class="metrics-card">Clicks: <strong id="perf-clicks">-</strong> <i class="fas fa-mouse"></i></div>
            <div class="metrics-card">Impressions: <strong id="perf-impr">-</strong> <i class="fas fa-eye"></i></div>
            <div class="metrics-card">CTR: <strong id="perf-ctr">-</strong></div>
          </div>
          <div style="height:240px;">
            <canvas id="campaignPerfChart"></canvas>
          </div>
        </div>
        <div>
          <div class="preview" id="perf-ad-preview"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- Top-up Modal -->
  <div id="topupModal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content" role="document">
      <button class="modal-close close-modal" aria-label="Close">&times;</button>
      <h2>Top Up Balance</h2>

      <!-- Step 1: Payment Info -->
      <div id="topup-step-1">
        <label for="topup-amount-input">Amount (ETB)</label>
        <input id="topup-amount-input" type="number" min="1" step="0.01" required>

        <label for="mobile-input">Mobile Number</label>
        <input
          id="mobile-input"
          type="tel"
          placeholder="e.g., 09xxxxxxxx or +2519xxxxxxxx"
          required
        >

        <!-- Payment Methods -->
        <div class="payment-methods">
          <h3>Select Payment Method</h3>
          <div class="methods-grid">
            
            <!-- Telebirr -->
            <label class="method-option" role="radio" aria-checked="true">
              <input type="radio" name="payment_type" value="telebirr" checked>
              <img
                src="https://upload.wikimedia.org/wikipedia/en/a/a4/Telebirr.png"
                alt="Telebirr Logo"
              >
              <span>Telebirr</span>
            </label>

            <!-- M-Pesa -->
            <label class="method-option" role="radio" aria-checked="false">
              <input type="radio" name="payment_type" value="mpesa">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/0/0b/M-PESA.png"
                alt="M-Pesa Logo"
              >
              <span>M-Pesa</span>
            </label>

            <!-- CBE Birr -->
            <label class="method-option" role="radio" aria-checked="false">
              <input type="radio" name="payment_type" value="cbebirr">
              <img
                src="https://play-lh.googleusercontent.com/rcSKabjkP2GfX1_I_VXBfhQIPdn_HPXj5kbkDoL4cu5lpvcqPsGmCqfqxaRrSI9h5_A"
                alt="CBE Birr Logo"
              >
              <span>CBE Birr</span>
            </label>

            <!-- Coopay E-Birr -->
            <label class="method-option" role="radio" aria-checked="false">
              <input type="radio" name="payment_type" value="ebirr">
              <img
                src="https://coopbankoromia.com.et/wp-content/uploads/2021/04/coopay-ebirr-scaled.jpg"
                alt="Coopay E-Birr Logo"
              >
              <span>Coopay E-Birr</span>
            </label>

          </div>
        </div>

        <!-- Step 1 Actions -->
        <div class="form-actions">
          <button
            id="generate-payment-btn"
            class="btn btn-primary disabled"
            disabled
            aria-disabled="true"
          >
            <span class="btn-text">Proceed to Payment</span>
            <span class="button-spinner"></span>
          </button>
        </div>
      </div>

      <!-- Step 2: Payment Confirmation -->
      <div id="topup-step-2" aria-live="polite">
        
        <!-- Loading Overlay -->
        <div id="loading-btn">
          <div>
            Verifying your payment...
            <span class="button-spinner"></span>
          </div>
        </div>

        <!-- Payment Details -->
        <img id="payment-logo" src="" alt="Payment Method Logo">
        <p><strong>Complete Your Payment:</strong></p>
        <p id="payment-details"></p>
        <p id="payment-instruction"></p>

        <!-- Step 2 Actions -->
        <div class="form-actions">
          <button
            id="confirm-payment-btn"
            class="btn btn-success disabled"
            disabled
            aria-disabled="true"
          >
            <span class="btn-text">View Balance</span>
            <span class="button-spinner"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="modal" aria-hidden="true" role="dialog">
    <div class="modal-content" role="document">
      <button class="modal-close close-modal" aria-label="Close">&times;</button>
      <h2 id="deleteConfirmTitle">Delete Campaign</h2>
      <p>Are you sure you want to delete this campaign? This action will archive the campaign and cannot be undone.</p>
      <div class="form-actions">
        <button type="button" id="deleteConfirmBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="spinner" role="status" aria-label="Loading"></div>
  </div>
{% endblock %}

{% block extra_styles %}
<style>
  #languageChart {
    max-height:200px !important; 
    max-width: 200px !important;
  }
</style>
{% endblock %}
{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="{% static 'js/advertiser/dashboard.js' %}"></script>
{% endblock %}