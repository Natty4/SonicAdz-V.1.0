# name: Daily PostgreSQL Database Backup

# on:
#   schedule:
#     - cron: '0 0 * * *' # Runs at 12 AM UTC daily
#   workflow_dispatch:     # Allows manual triggering

# jobs:
#   backup:
#     runs-on: ubuntu-latest

#     env:
#       DB_URL: ${{ secrets.DB_URL }}
#       SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
#       SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
#       SUPABASE_BUCKET: ${{ secrets.SUPABASE_BUCKET }}
#       TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
#       TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.10'

#       - name: Set backup timestamp
#         run: echo "BACKUP_TS=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV

#       - name: Install dependencies
#         run: |
#           echo "psycopg2-binary" > requirements.txt
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Parse DB_URL
#         run: |
#             python -c """
#             import urllib.parse
#             parsed = urllib.parse.urlparse('${{ env.DB_URL }}')
#             print(f'DB_HOST={parsed.hostname}')
#             print(f'DB_PORT={parsed.port or 5432}')
#             print(f'DB_NAME={parsed.path.lstrip(\"/\")}')
#             print(f'DB_USER={parsed.username}')
#             print(f'DB_PASSWORD={parsed.password}')
#             """ >> $GITHUB_ENV

#       - name: Install PostgreSQL 17 client tools
#         run: |
#           # Remove any existing PostgreSQL packages to avoid conflicts
#           sudo apt-get remove -y --purge postgresql-client*
#           sudo rm -f /etc/apt/sources.list.d/pgdg.list
          
#           # Install prerequisites
#           sudo apt-get install -y wget gnupg2
          
#           # Add PostgreSQL 17 repository with proper key handling
#           sudo sh -c 'echo "deb [arch=amd64] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
#           wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
#           sudo apt-get update
#           sudo apt-get install -y postgresql-client-17

#       - name: Verify pg_dump version
#         run: |
#           pg_dump --version
#           echo "PostgreSQL client tools installed successfully"
         
#       - name: Send Telegram notification (Backup Started)
#         run: |
#           curl -s -X POST https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage \
#             -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
#             -d text="ðŸ“¦ Database backup started at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

#       - name: Create database backup
#         run: |
#           export PGPASSWORD=${{ env.DB_PASSWORD }}
#           pg_dump -h ${{ env.DB_HOST }} -p ${{ env.DB_PORT }} -U ${{ env.DB_USER }} -d ${{ env.DB_NAME }} \
#             --no-owner --no-privileges -F c -f backup_${{ env.BACKUP_TS }}.dump

#       - name: Upload backup to Supabase (with retry)
#         run: |
#           success=false
#           for i in {1..3}; do
#             curl -f -X POST "${{ env.SUPABASE_URL }}/storage/v1/object/${{ env.SUPABASE_BUCKET }}/backup_${{ env.BACKUP_TS }}.dump" \
#               -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
#               -H "Content-Type: application/octet-stream" \
#               --data-binary "@backup_${{ env.BACKUP_TS }}.dump" > upload.log 2>&1 && success=true && break
#             cat upload.log  # Log errors for debugging
#             echo "Retrying upload in 5s..."
#             sleep 5
#           done
#           if [ "$success" != "true" ]; then
#             echo "Upload failed after 3 attempts. Last error:"
#             cat upload.log
#             exit 1
#           fi

#       - name: Send Telegram notification (Backup Completed)
#         run: |
#           curl -s -X POST https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage \
#             -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
#             -d text="âœ… Database backup completed successfully at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

#       - name: Clean up old backups (older than 7 days)
#         run: |
#           python -c "
#           import os
#           import json
#           import subprocess
#           from datetime import datetime, timedelta

#           bucket = os.environ['SUPABASE_BUCKET']
#           url = os.environ['SUPABASE_URL']
#           key = os.environ['SUPABASE_KEY']
#           cutoff = (datetime.utcnow() - timedelta(days=7)).strftime('%Y%m%d')

#           result = subprocess.run(
#               ['curl', '-s', '-X', 'POST', f'{url}/storage/v1/object/list/{bucket}', 
#                '-H', f'Authorization: Bearer {key}', 
#                '-H', 'Content-Type: application/json', 
#                '-d', '{}'],
#               capture_output=True, text=True
#           )

#           try:
#               files = json.loads(result.stdout)
#               for file in files:
#                   name = file.get('name', '')
#                   if name.startswith('backup_') and name.endswith('.dump'):
#                       date_str = name[7:15]  # Extract YYYYMMDD from backup_YYYYMMDD_HHMMSS.dump
#                       if date_str < cutoff:
#                           print(f'Deleting old backup: {name}')
#                           subprocess.run([
#                               'curl', '-s', '-X', 'DELETE', f'{url}/storage/v1/object/{bucket}/{name}',
#                               '-H', f'Authorization: Bearer {key}'
#                           ])
#                       else:
#                           print(f'Skipping recent backup: {name} (within 7 days)')
#                   else:
#                       print(f'Skipping non-backup file: {name}')
#           except Exception as e:
#               print(f'Error parsing Supabase list output: {e}')
#           "

#       - name: Clean up local files
#         run: rm -f backup_*.dump

#       - name: Send Telegram notification (Backup Failed)
#         if: failure()
#         run: |
#           curl -s -X POST https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage \
#             -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
#             -d text="âŒ Database backup failed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
